<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>AR.js Geolocation Experience</title>
    
    <!-- A-Frame and AR.js libraries -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        .status-overlay {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 999;
            max-width: 300px;
        }
        
        .status-overlay .coords {
            color: #00ff00;
            margin-top: 5px;
        }
        
        .status-overlay .distance {
            color: #ffff00;
            margin-top: 5px;
        }
        
        .status-overlay .error {
            color: #ff0000;
            margin-top: 5px;
        }
        
        .status-overlay .heading {
            color: #00ffff;
            margin-top: 5px;
        }
        
        .permission-prompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
        }
        
        .permission-prompt button {
            margin-top: 20px;
            padding: 10px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .controls {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 999;
        }
        
        .controls button {
            display: block;
            margin: 5px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 1px solid white;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Status overlay for debugging -->
    <div id="status" class="status-overlay">
        <div>GPS Status: <span id="gps-status">Initializing...</span></div>
        <div class="coords">Lat: <span id="lat">--</span></div>
        <div class="coords">Lng: <span id="lng">--</span></div>
        <div class="coords">Accuracy: <span id="accuracy">--</span>m</div>
        <div class="distance">Distance to Object: <span id="distance">--</span>m</div>
        <div class="heading">Compass: <span id="heading">--</span>Â°</div>
        <div class="heading">Camera Active: <span id="camera-status">No</span></div>
    </div>
    
    <!-- Controls for adjusting position -->
    <div class="controls">
        <button onclick="adjustAltitude(5)">Raise Objects +5m</button>
        <button onclick="adjustAltitude(-5)">Lower Objects -5m</button>
        <button onclick="resetAltitude()">Reset Altitude</button>
        <button onclick="useCurrentLocation()">Use My Location</button>
    </div>
    
    <!-- Permission prompt (initially hidden) -->
    <div id="permission-prompt" class="permission-prompt" style="display: none;">
        <h2>Location Permission Required</h2>
        <p>This AR experience needs access to your GPS location and camera to show virtual objects in the real world.</p>
        <button onclick="requestPermissions()">Grant Permissions</button>
    </div>
    
    <!-- A-Frame Scene with AR.js -->
    <a-scene
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        embedded
        renderer="logarithmicDepthBuffer: true; precision: high; antialias: true; alpha: true;">
        
        <!-- Camera with GPS tracking - adjusted parameters for better tracking -->
        <a-camera 
            id="camera"
            gps-new-camera="gpsMinDistance: 1; positionMinAccuracy: 20; alert: true;"
            rotation-reader
            position="0 0 0"
            look-controls="enabled: false"
            arjs-device-orientation-controls
            cursor="rayOrigin: mouse"
            raycaster="objects: [gps-new-entity-place]">
        </a-camera>
        
        <!-- Main 15x15x15 meter cube with bright color and wireframe for visibility -->
        <a-box
            id="test-box-main"
            material="color: #FF0000; opacity: 0.7; wireframe: false;"
            scale="15 15 15"
            position="0 7.5 0"
            gps-new-entity-place="latitude: 49.5749; longitude: 11.0293;"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 20000">
        </a-box>
        
        <!-- Wireframe overlay for better visibility -->
        <a-box
            id="test-box-wireframe"
            material="color: #FFFF00; wireframe: true; wireframeLinewidth: 2;"
            scale="15 15 15"
            position="0 7.5 0"
            gps-new-entity-place="latitude: 49.5749; longitude: 11.0293;">
        </a-box>
        
        <!-- Ground level marker - 1m cube at ground -->
        <a-box
            id="ground-marker"
            material="color: #00FF00; opacity: 0.8;"
            scale="1 1 1"
            position="0 0.5 0"
            gps-new-entity-place="latitude: 49.5749; longitude: 11.0293;">
        </a-box>
        
        <!-- Tall pole to help locate objects - 30m high -->
        <a-cylinder
            id="location-pole"
            material="color: #0000FF; opacity: 0.8;"
            radius="0.5"
            height="30"
            position="0 15 0"
            gps-new-entity-place="latitude: 49.5749; longitude: 11.0293;">
        </a-cylinder>
        
        <!-- Ground plane indicator - larger and more visible -->
        <a-plane
            id="ground-plane"
            material="color: #FFFF00; opacity: 0.3; side: double;"
            rotation="-90 0 0"
            scale="25 25 1"
            position="0 0.1 0"
            gps-new-entity-place="latitude: 49.5749; longitude: 11.0293;">
        </a-plane>
        
        <!-- Text label floating above -->
        <a-text
            id="label"
            value="15m CUBE HERE"
            scale="10 10 10"
            position="0 20 0"
            align="center"
            color="#FFFFFF"
            gps-new-entity-place="latitude: 49.5749; longitude: 11.0293;">
        </a-text>
        
    </a-scene>
    
    <script>
        // Configuration - UPDATE THESE WITH YOUR ACTUAL COORDINATES
        const TARGET_LOCATION = {
            latitude: 49.5749,  // Replace with your lawn's latitude
            longitude: 11.0293  // Replace with your lawn's longitude
        };
        
        let userLocation = null;
        let watchId = null;
        let currentAltitude = 0;
        
        // Request permissions
        function requestPermissions() {
            document.getElementById('permission-prompt').style.display = 'none';
            startLocationTracking();
            
            // Also request camera permissions explicitly
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => {
                        console.log('Camera access granted');
                        document.getElementById('camera-status').textContent = 'Yes';
                        document.getElementById('camera-status').style.color = '#00ff00';
                        // Stop the stream immediately, AR.js will handle it
                        stream.getTracks().forEach(track => track.stop());
                    })
                    .catch(err => {
                        console.error('Camera access denied:', err);
                        document.getElementById('camera-status').textContent = 'Error';
                        document.getElementById('camera-status').style.color = '#ff0000';
                    });
            }
        }
        
        // Adjust altitude of all objects
        function adjustAltitude(delta) {
            currentAltitude += delta;
            const entities = document.querySelectorAll('[gps-new-entity-place]');
            entities.forEach(entity => {
                const position = entity.getAttribute('position');
                if (position) {
                    entity.setAttribute('position', {
                        x: position.x,
                        y: position.y + delta,
                        z: position.z
                    });
                }
            });
            console.log('Adjusted altitude by', delta, 'meters. Total offset:', currentAltitude);
            alert(`Objects moved ${delta > 0 ? 'up' : 'down'} by ${Math.abs(delta)}m`);
        }
        
        function resetAltitude() {
            const entities = document.querySelectorAll('[gps-new-entity-place]');
            entities.forEach((entity, index) => {
                // Reset to original positions
                if (entity.id === 'test-box-main' || entity.id === 'test-box-wireframe') {
                    entity.setAttribute('position', '0 7.5 0');
                } else if (entity.id === 'ground-marker') {
                    entity.setAttribute('position', '0 0.5 0');
                } else if (entity.id === 'location-pole') {
                    entity.setAttribute('position', '0 15 0');
                } else if (entity.id === 'ground-plane') {
                    entity.setAttribute('position', '0 0.1 0');
                } else if (entity.id === 'label') {
                    entity.setAttribute('position', '0 20 0');
                }
            });
            currentAltitude = 0;
            alert('Altitude reset to original values');
        }
        
        // Use current GPS location as object location
        function useCurrentLocation() {
            if (userLocation) {
                const lat = userLocation.coords.latitude;
                const lng = userLocation.coords.longitude;
                
                // Update all entities to current location
                const entities = document.querySelectorAll('[gps-new-entity-place]');
                entities.forEach(entity => {
                    entity.setAttribute('gps-new-entity-place', `latitude: ${lat}; longitude: ${lng};`);
                });
                
                TARGET_LOCATION.latitude = lat;
                TARGET_LOCATION.longitude = lng;
                
                alert(`Objects moved to your current location:\nLat: ${lat.toFixed(6)}\nLng: ${lng.toFixed(6)}`);
            } else {
                alert('GPS location not available yet');
            }
        }
        
        // Calculate distance between two GPS points using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;
            
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // Update status display
        function updateStatus(position) {
            document.getElementById('lat').textContent = position.coords.latitude.toFixed(6);
            document.getElementById('lng').textContent = position.coords.longitude.toFixed(6);
            document.getElementById('accuracy').textContent = position.coords.accuracy.toFixed(1);
            
            if (position.coords.heading !== null) {
                document.getElementById('heading').textContent = position.coords.heading.toFixed(1);
            }
            
            const distance = calculateDistance(
                position.coords.latitude,
                position.coords.longitude,
                TARGET_LOCATION.latitude,
                TARGET_LOCATION.longitude
            );
            
            document.getElementById('distance').textContent = distance.toFixed(1);
            document.getElementById('gps-status').textContent = 'Active';
            document.getElementById('gps-status').style.color = '#00ff00';
            
            // Log for debugging
            console.log('GPS Update:', {
                userLat: position.coords.latitude,
                userLng: position.coords.longitude,
                targetLat: TARGET_LOCATION.latitude,
                targetLng: TARGET_LOCATION.longitude,
                distance: distance,
                accuracy: position.coords.accuracy
            });
        }
        
        // Start GPS tracking
        function startLocationTracking() {
            if ('geolocation' in navigator) {
                const options = {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 27000
                };
                
                // Get initial position
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('Initial position obtained:', position);
                        userLocation = position;
                        updateStatus(position);
                        
                        // Update camera position
                        const camera = document.getElementById('camera');
                        if (camera) {
                            // Remove simulation attributes once we have real GPS
                            camera.setAttribute('gps-new-camera', {
                                positionMinAccuracy: 20,
                                gpsMinDistance: 1,
                                alert: true
                            });
                        }
                    },
                    (error) => {
                        console.error('GPS Error:', error);
                        document.getElementById('gps-status').textContent = 'Error: ' + error.message;
                        document.getElementById('gps-status').style.color = '#ff0000';
                    },
                    options
                );
                
                // Watch position for updates
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        console.log('Position update:', position);
                        userLocation = position;
                        updateStatus(position);
                    },
                    (error) => {
                        console.error('GPS Watch Error:', error);
                        document.getElementById('gps-status').textContent = 'Watch Error';
                        document.getElementById('gps-status').style.color = '#ff0000';
                    },
                    options
                );
            } else {
                alert('Geolocation is not supported by your browser');
            }
        }
        
        // Monitor device orientation
        window.addEventListener('deviceorientation', (event) => {
            if (event.alpha !== null) {
                document.getElementById('heading').textContent = event.alpha.toFixed(1);
            }
        });
        
        // Initialize on page load
        window.addEventListener('load', () => {
            // Check camera stream status
            const scene = document.querySelector('a-scene');
            if (scene) {
                scene.addEventListener('camera-init', () => {
                    console.log('AR.js camera initialized');
                    document.getElementById('camera-status').textContent = 'Yes';
                    document.getElementById('camera-status').style.color = '#00ff00';
                });
                
                scene.addEventListener('camera-error', () => {
                    console.log('AR.js camera error');
                    document.getElementById('camera-status').textContent = 'Error';
                    document.getElementById('camera-status').style.color = '#ff0000';
                });
            }
            
            // Check if we need to show permission prompt
            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then((result) => {
                    if (result.state === 'granted') {
                        requestPermissions(); // Also requests camera
                    } else {
                        document.getElementById('permission-prompt').style.display = 'block';
                    }
                });
            } else {
                // Fallback for browsers without Permissions API
                requestPermissions();
            }
            
            // Add event listeners for AR.js debugging
            window.addEventListener('gps-camera-update-position', e => {
                console.log('ðŸ“ Camera GPS position updated:', e.detail);
            });
            
            window.addEventListener('gps-entity-place-update-position', e => {
                console.log('ðŸ“¦ Entity position updated:', e.detail);
            });
            
            window.addEventListener('gps-entity-place-added', e => {
                console.log('âœ… Entity added to scene:', e.detail);
            });
            
            // Log AR.js initialization
            console.log('AR.js Location-based AR initialized');
            console.log('Target location:', TARGET_LOCATION);
        });
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        });
    </script>
</body>
</html>